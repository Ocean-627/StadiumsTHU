---
typora-root-url: ./photo
---

# 清动家园交付文档

*清华大学软件学院软件工程 2020年秋 C03 组*

## 交付产品

**服务器域名：**https://cbx.iterator-traits.com/

**小程序码：**

**管理员账号：**2020010001

**密码：**12345678

## 产品目标

### 📌 功能要求

#### 普通用户

通过登录清动家园小程序端，普通用户能够方便快捷地进行场馆预订，具体的操作流程如下图所示。

<img src="user.png" alt="avatar" style="zoom:30%;" />

#### 管理员

### 📈 性能要求



## 开发组织管理

### 👣 过程管理

#### 每周会议

团队定于每周二晚9:00于南区十号楼地下讨论区举行每周会议，要求全体成员必须参加。部分成员临时有事可提前说明并重新确定当周会议日期，每次会议持续约两个小时，主要用于总结上周进展及布置下周任务，团队成员集体讨论相关问题的解决方案并尽可能地达成一致意见。

#### 集中开发

团队定于每周四下午或晚上于清华学堂地下研讨间进行集中开发，集中开发时间固定为4个小时。集中开发期间，主要解决上次会议后在实现过程中发现问题需要更改相关标准的模块。

### 👬 人员分工
**胡浩宇**

- 小程序端界面开发

- 小程序端部署

**陈柏旭**

- 数据库表与后端接口设计
- 后端用户相关接口及管理员相关部分接口
- 测试相关

**杨宇泓**

- Web前端界面开发
- Web端部署

**徐鑫浩**

- 数据库表与后端接口设计
- 后端管理员相关部分接口
- Web前端部分界面的调整与接口的对接

### 🔨 开发环境

| 类别       | 集成开发环境       | 框架          |
| ---------- | ------------------ | ------------- |
| 小程序前端 | 微信开发者工具     | VantUI + WeUI |
| Web前端    | Visual Studio Code | Vue + jQuery  |
| 后端       | Pycharm            | Django        |

### 🔑 配置管理

项目大体上沿以下4个分支进行开发。

- **master**分支存储经完备测试后的代码。
- **web-frontend**分支用于编写Web前端静态界面。
- **webapp**分支用于编写Web前端与后端的交互代码，并定期将测试后的代码merge到**web-frontend**上。
- **backend**分支主要用于后端开发。

由于小程序端开发相对独立，且小程序端开发人员所做工作与其他成员的工作耦合程度很低，故小程序前端只需定期将所做工作push到**master**分支即可。

<img src="branch.png" alt="avatar" style="zoom:30%;" />

## 系统设计

### 前端交互 - 用户系统（小程序端）

#### 架构选择

用户预约场地相对于管理员管理场馆信息来说是一个比较简单且信息量不那么丰富的操作，此外考虑到用户日常访问网络更多依靠手机，平板这样的移动设备而不是电脑，所以采用移动端的应用来进行预约系统的开发更加合理。而在移动端应用程序的选择上，小程序相比于APP更贴近于传统的web前端设计方式，降低了学习成本，且小程序底层具备安卓和IOS的兼容性，因此，我们选择小程序进行预定场地系统的开发。

在UI界面的设计上，为了实现美观和部分界面较复杂的筛选逻辑，采用了VantUI+WeUI以及自己实现的样式结合的方式。

#### 业务实现

- 认证登录：用户通过清华校园身份认证登录
- 场馆浏览：浏览所有的场馆（包括它们的名称，位置，开放时间，运动项目等信息）
  - 场馆筛选：通过运动项目，收藏，开放信息进行筛选，通过距离，人气，评分进行排序，关键词搜索
  - 场馆查看：查看场馆具体信息，包括简介，须知，他人评论
  - 位置查询与地图导航：通过地图上的标记和路线图告知用户相关信息
  - 收藏场馆：将场馆加入收藏
- 场地预约：查看可以预约的场地并选择可以预约的时段
  - 场地筛选：通过运动项目，日期，场地编号进行筛选
  - 预约确认：显示预约的各项信息以供用户确认
  - 预约付款：通过多种付款方式进行付款
- 预约记录：查看各种状态中的预约记录（未付款，已付款，进行中，待评论，已评论，已取消）
  - 取消预约：用户可以在预约尚未开始的一段时间内取消预约
  - 前往付款：用户可以为尚未付款的预约进行付款
  - 评论/查看/撤销评论：用户可以评论场地/查看过去的评论内容/撤销过去的评论
  - 删除预约记录：用户可以删除已评论和已取消的预约记录
- 个人信息：用户可以管理自己的个人信息（头像，联系电话，邮箱，昵称）
- 浏览历史：用户可以查看自己的浏览历史记录
- 使用教程
- 消息通知：用户会在预约成功/预约被取消/预约即将开始和结束时收到服务通知

### 前端交互 - 管理系统（Web应用端）

#### 架构选择

考虑到管理员工作的主要需求在于能浏览不同类型的数据，在此之上对场馆、用户等数据记录进行管理，我们认为管理系统的交互重点与用户系统的**简单易用**不同，更应该偏向于**功能化**，同时应该合并对同样资源的重复处理。因此我们选择使用Web端进行管理系统的架构。

同时，为了适配可能出现的特别需求，我们采用了基于Bootstrap实现的响应式前端框架，在平板电脑（以iPad为例），甚至屏幕更小的手机上，我们的管理系统也有接近完整的使用体验，而不会出现样式大规模丢失或是操作流程错误的现象。

<img src="web-phone.jpeg" alt="avatar" style="zoom:14%;" />      <img src="web-ipad.PNG" alt="avatar" style="zoom:14%;" />

#### 业务实现

作为运动场馆预约系统的管理员，首要的业务需求应该在于对**场馆**、**用户**以及**预订记录**的管理。我们根据页面的结构，对上述业务实现进行介绍。

- 首页：提供过去七天内各场馆、各类运动场预定情况的数据统计结果。

  <img src="web-home.png" alt="avatar" style="zoom:20%;" />

- 场馆管理
  - 场馆列表
    - 添加新场馆：创建一个可供预约的新场馆。
    - 编辑场馆信息：对场馆基本信息（场馆说明、联系方式、场馆图片等）的修改。
    - 修改预定时间段：对场馆可预订时间、可预订场地的修改。
    - 场地预留：管理员可以根据活动举办/场地维护/课程占用等需要，对指定场地进行预留；也可以用于对工会体委上报的预订需求进行批量预订。
    - 查看预约：查看当前场馆已有的预约。

<img src="web-stadium.png" style="zoom:30%;" />


  - 用户反馈：用于查看用户的评论、评分。
  
- 用户管理：管理员在此查看用户信息，进行用户信息的批量导出，或对用户的预订记录、信用和黑名单状况进行查看和管理。

- 操作记录：管理员在此查看自己以及其他管理员的操作记录，并可以对部分误操作进行撤销。

- 系统日志：用于存放系统的发布和更新日志。

### 后端模块

### 接口规范

### 数据库设计

## 重难点问题及其解决方法

## 测试总结

### 功能测试方法

### 缺陷汇总

### 性能测试方法

#### 小程序端

通过微信小程序开发调试 -> 性能监控面板可以对小程序运行时的各项性能数据进行监测。

### 性能测试结果

#### 小程序端

| 性能数据     | 波动范围                              |
| ------------ | ------------------------------------- |
| CPU          | 10%-25%                               |
| 内存         | 700-800m                              |
| 页面切换耗时 | 200-500ms                             |
| 启动耗时     | 1.5-2.5s                              |
| 帧率         | 基本稳定在60fps                       |
| 数据缓存     | 175B - 25KB（与历史记录最大条数有关） |



### 兼容性测试

#### 小程序端

由于小程序依赖于微信底层的特殊性，不同的微信小程序版本对于我们小程序部分功能和页面样式的兼容性有所不同。同时微信小程序需要在各种尺寸的手机以及平板电脑上运行，页面样式是否会变形，是否会影响使用也是测试关注的重点。

###### 测试方法

通过微信开发者工具，调整调试版本库，观察每个页面是否能正常渲染，功能是否能正常运作。通过模拟器调节不同的机型，观察每个页面的渲染情况。

###### 测试结果

版本兼容性：

| 版本            | 功能情况             | 页面情况                    |
| --------------- | -------------------- | --------------------------- |
| 2.10.4 - latest | 完整                 | 完整                        |
| 2.9.5 - 2.10.4  | 推送通知无法使用     | 完整                        |
| 2.7.7 - 2.9.5   | 地图导航无法使用     | 完整                        |
| 2.0.9-2.7.7     | 同上                 | 预约界面scroll-view排版错误 |
| 2.0.9以下       | 预约记录无法切换分页 | VantUi大面积失效            |

机型兼容性：

| 机型               | 页面情况                                                     |
| ------------------ | ------------------------------------------------------------ |
| ipad Pro 10.5 12.9 | 预约记录和场馆信息页面按钮与文字比例不协调，主页场馆信息行间距有差异 |
| 其它               | 视觉效果符合预期                                             |



## 系统部署

### 部署环境

Ubuntu Server 20.04 LTS 64位 服务器

### 容器部署

项目使用基于 Docker (version 19.03.13) 的容器部署方式。使用到的镜像为：

- python: 3.7 - 用于部署后端应用，容器暴露 8000 端口。
- mysql: 5.7 - 用于部署数据库，容器暴露 3306 端口，与后端共享一个网络，仅供后端访问。
- nginx: latest - 用于部署代理，映射主机的 80 和 443 端口，与后端共享一个网络。

为了信息安全，数据库的隐私设置使用``.env``文件进行配置。

### NGINX反向代理部署

#### 多进程和并发链接设置

项目的 nginx 代理配置了 2 个工作进程数（worker_processes），每个进程使用 **epoll** 进行性能优化，支持的最大并发链接数为1024/进程。

#### http/https 协议设置

代理限制了请求的Header大小不超过2k（否则会返回494错误）。

请求的主体部分（body）不得超过20M。

代理开放了用于http服务的80端口，以及用于https服务的443端口。http请求将会被重定向到https的端口，同时返回**http301**。单个https的会话过期时间为一天。https使用ssl协议进行加密。

#### 代理路径设置

代理对四种路径进行分发：

- ``/`` ：非以下类型的路径将被分发到前端Vue处，作为前端网站访问。
- ``/api`` ：后端接口使用的路径，转发到后端处理。
- ``/media`` ：图片、视频等文件的访问接口。
- ``/static`` ：静态文件服务。

### 小程序端部署

#### 小程序发布

通过直接在微信公众平台上发布小程序，其他人可以直接在微信 - 搜索小程序中通过名称“**清动家园**”直接搜索到我们的小程序。

(PS：由于发布版小程序直接跳转到了发布版清华校友会小程序，无法正常验证身份，所以还是请使用体验版)

可以扫描下方二维码，申请使用体验版。

<img src="/miniprogram_code.jpg" style="zoom:50%;" />

#### 本地运行

小程序的代码与小程序号（appid）是绑定的，所以如果想运行他人的小程序稍有些复杂。

1. 在[微信公众平台](https://mp.weixin.qq.com)申请成为小程序开发者并获得一个小程序号。
2. 修改**微信小程序**文件夹下的**project.config.json**文件，将里面的**appid**字段修改为获得的小程序号。
3. 打开微信开发者工具 -> 导入项目 -> 选择微信小程序文件夹 -> appid输入获得的小程序号 -> 导入
4. 控制台输入 npm install
5. 微信开发者工具中选择 工具 -> 构建npm 
6. 默认情况下小程序由于没有loginToken是无法登录的，开发者工具里面也无法进行小程序跳转，有两种办法可以解决这个问题
   - 在编译运行一次小程序后在调试器->Storage中查看本地数据，将loginToken字段设置为1(无引号)，再运行一次小程序即可通过一个默认的账户进入小程序。
   - 点击预览->自动预览，在手机上运行小程序。









